<!DOCTYPE html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.2//EN" "http://www.openmobilealliance.org/tech/DTD/xhtml-mobile12.dtd">
<!-- saved from url=(0082)file:///Users/art/devel/workspaceJava/Gardenoid/assets/webpages/devices/index.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Devices</title>    
    <script src="./Devices_files/jquery-1.11.1.min.js"></script>
    <!-- <script src="/js/jquery.min.js"></script> -->
    <script src="./Devices_files/gardenoid.js"></script>
            
    <script>
    
    var isDiscovering = null;
    var isConnected   = null;
    var currentPeer   = null;

    function unknown_status(data)
    {
		$("#statusPeerName").text("???");    	
    }
    
    function receive_status(data)
    {
    	try
    	{	    	    	
			var newConnected    = data["connected"];
		    var newDiscovering  = data["discovering"];
		    var newPeer         = data["peer"];			    
		    
		    if (newPeer!=currentPeer)
		    {
		    	currentPeer = newPeer;
		    	$("#statusPeerName"   ).text(null==currentPeer ? "" : currentPeer);
		    }			    
		    
		    if (newDiscovering!=isDiscovering)
		    {
		    	isDiscovering = newDiscovering;
			    // https://www.iconfinder.com/iconsets/30_Free_Black_ToolBar_Icons
			    // http://www.ajaxload.info/
		    	var src = (isDiscovering ? "/img/spinner.gif" : "/img/discover.png");
		    	$("#statusImage")[0].src = src;
			}
			
			if (newConnected!=isConnected)
			{		    	
				isConnected = newConnected;
		    	$("#status")[0].className = (isConnected ? "status_on" : "status_off");
		    }
		}
		catch (e)
		{
			alert("receive_status: " +  e);
		}		    	    	
    }    
    
    
    function handle_json_error(jqXHR,exception,msg)    
    {
    	alert("handle_json_error");
    	if (console)
		{
			console.log("handle_json_error: exception=" + exception + ", msg=" + msg + ", json=" + jqXHR.responseText);
		}
		    
		var div = $("#jsonErrorLog");
		if (div)
		{
			div.text(msg);
		}
    }    
    

    function update_status()
    {
    	try
    	{	    	    	
	    	var url     = "/rest/status?connected=" + isConnected + "&discovering=" + isDiscovering + "&peer=" + currentPeer;
	    	var request = $.getJSON(url, receive_status);	    	
	    	request.success(function()      { setTimeout(update_status,  250); });
	    	request.error(  function(a,b,c) { handle_json_error(a,b,c); unknown_status(); setTimeout(update_status, 4000); });
	    }
	    catch (e)
	    {
	    	alert("update_status: Exception: " + e);	
	    }
    }
    
    function clear_devices()
    {
	    	 	div = $("#divDevices");
	    	 	div.empty();
    }
    
    function update_devices()
    {
    	var request = $.getJSON("/rest/devices/list", function(data)
    	{
    		try
    		{
	    	 	devices = data["devices"];
	    		text = "";
	    	 	    	 	
	    	 	$.each(devices, function(i,device)
	    	 	{ 
	    	 		var paired  = device["paired"];
	    	 		var visible = device["visible"];
	    	 		var addr    = device["addr"];
	    	 		var name    = device["name"] + " (" + (paired ? "P" : "") + (visible ? "V" : "") + ")";
	    	 		
	    	 		if (i%2)
	    	 		{
		    	 		clazz = paired ? "device_even_paired" : "device_even";
		    	 	}
		    	 	else
		    	 	{
		    	 		clazz = paired ? "device_odd_paired" : "device_odd";
		    	 	}	    	 				    	 	
	    	 		
					text += 
					    "  <div class=\"" + clazz + "\" id=\"device_" + addr + "\" onClick=\"select_device('" + addr + "')\">\n" +
						"    <div class=\"addr\">" + addr + "</div>\n" + 
						"    <div class=\"name\">" + name + "</div>\n" +  
						"  </div>\n";
	    	 	});
	    	 	    	 	
	    	 	div = $("#divDevices");
	    	 	div.empty();
	    	 	div.append(text);
	    	 }
	    	 catch (e)
	    	 {
	    	 	alert("update_devices: exception: " + e);
	    	 }
    	});
    	 
    	request.error(handle_json_error); 
    	request.success(function()   	{ console.log("update_devices succeeded"); setTimeout(update_devices, 4000); });	    	
    }
    
    function toggle_discovery()
    {
    	$.getJSON("/rest/discover/toggle?nonce=" + make_nonce(), function (data) {} );
    }
    
    {
    	$.getJSON("/rest/device/stop?nonce=" + make_nonce(), function (data) {} );
    }
        
    function select_device(addr)
    {
    	alert("select_device: " + addr);
    	$.getJSON("/rest/device/select?addr=" + addr + "&nonce=" + make_nonce(), function (data) 
    	{
    		success = data["success"];
    		alert("success: " + success);	
    	});
    }    
    
    function cancel_dialog()
    {
    	window.close();
    }
    </script>    
    
    <style type="text/css" media="screen">    
.status_on
{
	background: -webkit-gradient(linear, center top, center bottom, from(#73ba8a), to(#2c8749));
	border-bottom: 1px solid #111a33;
	-webkit-box-shadow: inset 0 1px 1px -1px #fff;
	-webkit-box-sizing: border-box;
	height: 43px;
	position: relative;
	width: 100%;
	z-index: 12;
	font-family: Helvetica, sans-serif;
	font-size: 14px;
	-webkit-box-align: center;
	display: -webkit-box;
}

.status_off
{
	background: -webkit-gradient(linear, center top, center bottom, from(#ff8a73), to(#a0492c));
	border-bottom: 1px solid #111a33;
	-webkit-box-shadow: inset 0 1px 1px -1px #fff;
	-webkit-box-sizing: border-box;
	height: 43px;
	position: relative;
	width: 100%;
	z-index: 12;
	font-family: Helvetica, sans-serif;
	font-size: 14px;
	-webkit-box-align: center;
	display: -webkit-box;
}

.menu 
{
	background: -webkit-gradient(linear, center top, center bottom, from(#808080), to(#a0a0a0));
	border-bottom: 1px solid #111a33;
	-webkit-box-shadow: inset 0 1px 1px -1px #fff;
	-webkit-box-sizing: border-box;
	height: 43px;
	position: relative;
	width: 100%;
	z-index: 12;
	font-family: Helvetica, sans-serif;
	font-size: 14px;
	-webkit-box-align: center;
	display: -webkit-box;
	text-align: center;
	margin-top: 10px;
}
body 
{
	text-align: left;
	direction: ltr;
	padding: 0;
	margin:  0;
	background-color: #303030;
}

.device_even
{
	text-shadow: white 0 1px 0;
	background-color: #b0b0b0;
	border-radius:    10px;
	margin:            5px;
	padding:		  10px;
	border: 2px inset #a0a0a0;
}

.device_odd
{
	text-shadow: white 0 1px 0;
	background-color: #d0d0d0;
	border-radius:    10px;
	margin:            5px;
	padding:		  10px;
}

.device_even_paired
{
	text-shadow: white 0 1px 0;
	background-color: #b0ffb0;
	border-radius:    10px;
	margin:            5px;
	padding:		  10px;
	border: 2px inset #a0a0a0;
}

.device_odd_paired
{
	text-shadow: white 0 1px 0;
	background-color: #d0f0d0;
	border-radius:    10px;
	margin:            5px;
	padding:		  10px;
}

.addr
{
	font-family: Courier;
	text-align: center;
	margin:            2px;
}

.name
{
	font-family: Arial;
	text-align: center;
	margin:            2px;
}

.statusPeerName
{
	border: 1px solid red;
	margin-left: auto;
    margin-right: auto;
}

.jsonErrorLog
{
	background-color: white;
	color: black;
	/*display:none;*/	
}
    </style>
        
  </head>
  
  <body>
  	
  	<div id="status" class="status_off">
		<div style="position:absolute; left:0px;  margin:5px;"><a href="javascript:toggle_discovery()"><img id="statusImage" src="./Devices_files/discover.png" width="32" height="32"></a></div>
		<p id="statusPeerName" class="statusPeerName">???</p>
		<div style="position:absolute; right:0px; margin:5px;"><a href="javascript:cancel_dialog()"><img id="cancelImage" src="./Devices_files/cancel.png" width="32" height="32"></a></div>
	</div>
	
  	<div id="divDevices">
  	</div>
  	
  	<!--
  	<div id="divTest">
      <div class="device_odd" id="device_00:00:00:00:00:00" onclick="select_device('00:00:00:00:00:00')">
	    <p class="name">DummyDevice</p> 
	    <p class="addr">00:00:00:00:00:00</p> 
	  </div>
      <div class="device_even" id="device_00:00:00:00:00:01" onclick="select_device('00:00:00:00:00:01')">
	    <div class="name">DummyDevice2</div> 
	    <div class="addr">00:00:00:00:00:01</div> 
	  </div>
  	</div>
	-->
  	
  	<div id="menu" class="menu">
  		<p style="text-align: center; width:100%">  	
  		  <a href="javascript:clear_devices()">[CLEAR]</a>
  		  <a href="javascript:update_devices()">[UPDATE]</a>
  		</p>
  	</div>
  	
  	<div id="jsonErrorLog" class="jsonErrorLog">error:</div>
  	
  
  
  <script>
   	$(document).ready(update_status());
	$(document).ready(update_devices());
  </script>
  

</body></html>