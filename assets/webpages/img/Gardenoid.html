<!DOCTYPE html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.2//EN" "http://www.openmobilealliance.org/tech/DTD/xhtml-mobile12.dtd">
<!-- saved from url=(0023)http://10.2.5.167:8080/ -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Gardenoid</title>    
    <script src="./Gardenoid_files/jquery-1.11.1.min.js"></script>
    <!-- <script src="/js/jquery.min.js"></script> -->
    <script src="./Gardenoid_files/gardenoid.js"></script>
            
    <script>
    
    var isDiscovering = null;
    var isConnected   = null;
    var currentPeer   = null;
    
    function log(msg)
    {
		try { console.log(msg); } catch (e) {}    		
   	}
    
    function receive_status(data)
    {
    	try
    	{	    	    	
			var newConnected    = data["connected"];
		    var newDiscovering  = data["discovering"];
		    var newPeer         = data["peer"];			    
		    
		    if (newPeer!=currentPeer)
		    {
		    	currentPeer = newPeer;
		    	$("#statusPeerName"   ).text(null==currentPeer ? "" : currentPeer);
		    }			    
		    
		    if (newDiscovering!=isDiscovering)
		    {
		    	isDiscovering = newDiscovering;
			    // https://www.iconfinder.com/iconsets/30_Free_Black_ToolBar_Icons
			    // http://www.ajaxload.info/
			    /*
		    	var src = (isDiscovering ? "/img/spinner.gif" : "/img/discover.png");
		    	$("#statusImage")[0].src = src;
		    	*/
			}
			
			if (newConnected!=isConnected)
			{		    	
				isConnected = newConnected;
		    	$("#status")[0].className = (isConnected ? "status_on" : "status_off");
		    }
		    
		    if (newPeer!=currentPeer)
		    {
		    	currentPeer = newPeer;
		    	$("#statusPeerName")[0].text = newPeer;
		    }
		}
		catch (e)
		{
			alert("receive_status: " +  e);
		}		    	    	
    }
    
    
    function update_status()
    {
    	try
    	{	    	    	
	    	var url     = "/rest/status?connected=" + isConnected + "&discovering=" + isDiscovering + "&peer=" + currentPeer;
	    	var request = $.getJSON(url, receive_status);
	    		    	
	    	request.success(function()
	    	{
		    	window.setTimeout(update_status, 500);		    		    		
	    	});
	    		    	
	    	request.error(function(a,b,c)
	    	{
	    		handle_json_error(a,b,c);
		    	window.setTimeout(update_status, 4000);		    		    		
	    	});	    	
	    }
	    catch (e)
	    {
	    	alert("update_status: Exception: " + e);	
	    }
    }


	function test_schedules()
	{
    	var s =
    	{
			"active"        : true,
			"dayMask"       : 255,
			"strandMask"    : 2+4+8+16,
			"monthMask"     : 8+16+32+64+128,
			"startTime"     : "08:00",
			"endTime"       : "20:00",
			"duration"      : "00:15",
			"interval"      : "01:00",
			"idCondition"   : 0,
			"idException"   : 0,
			"conditionArgs" : null,
			"exceptionArgs" : null
    	};
    	var template = $("#idScheduleTemplate");    	
 		var dom = create_schedules_dom(1, template, s);	
   	 	return dom;
	}    

    function clear_schedules()
    {
   	 	var target   = $("#idSchedules");
   	 	target.empty();    	
    }

	var schedulesFingerprint     = null;
	
    function update_schedules(action, id)
    {
    	log("update_schedules: was called. action=" + action +", id=" + id);
    	
    	var template = $("#idScheduleTemplate");    	
   	 	var target   = $("#idSchedules");
   	 	var url = "rest/schedules/list";
   	 	
   	 	if ("delete"==action)
   	 	{
   	 		try
   	 		{	
	   	 		sched = $("#"+id);
	   	 		sched.hide("slow");
	   	 		return;
   	 		}
   	 		catch (e)
   	 		{
   	 			alert("update_schedules: " + e);
   	 		}
   	 	}
   	 	else if ("insert"==action)
   	 	{
   	 		var url = "rest/schedules/get?id=" + id;
   	 		alert("url: " + url);
   	 		
	    	var request = $.getJSON(url, function(data)
	    	{
	   	 		try
	   	 		{
			    	 	var schedule = data["schedule"];
			    	 	alert("got single schedule: " + schedule)
			    	 	var dom = create_schedules_dom(i, template, schedule);
			    	 	alert("created dom for single schedule: " + dom);
			    	 	dom.hide();	  
			    	 	appended = target.append(dom);  		
			    	 	alert("dom appended. appended=" + appended);
			    	 	appendedArray.show("slow");
			    }
			    catch (e)
		    	{
		    		alert("" + e);
		    	}
	    	});
	    	
	    	return;
   	 	}
   	 	
   	 	try
   	 	{
   	 		url += "?fingerprint=" + schedulesFingerprint;
   	 	}
   	 	catch (e) {}
   	 	
    	var request = $.getJSON(url, function(data)
    	{
    	 	var schedules = data["schedules"];
    	 	schedulesFingerprint = data["fingerprint"];
    	 	
    	 	var doms = [];
    	 	$.each(schedules, function(i,schedule)
    	 	{
    	 		var dom = create_schedules_dom(i, template, schedule);	
		   	 	doms.push(dom);
    	 	});	    	

	   	 	target.empty();
	   	 	doms.forEach(function(dom)
	   	 	{
	   	 		target.append(dom);	
	   	 	});	   	 	
		});
		
		request.error(handle_json_error);
		request.complete(window.setTimeout(update_schedules,5000));
    }

    function create_schedules_dom(no, template, schedule)
    {
    	var s  = schedule;    	 
    	var id     = s["id"];
    	var active = s["active"];

    	//alert("create_schedules_dom: template: " + template);
    	copy = template.clone();
    	copy.removeAttr("id");
    	copy.attr("id", id);
    	dom = $(copy)
    	
    	if (active) dom.addClass("active");
    	if (no%2)   dom.addClass("odd");
    	
    	mask  = s["strandMask"];
    	nodes = dom.find(".strand");
    	for (i=1; i<=8; i++)
    	{
    		name = "strand" + 1;
    		nodes.filter("[name=strand" + i + "]")[0].classList.add(mask%2 ? "sx" : "ux");  
    		mask = mask>>1;
    	}

    	mask  = s["dayMask"];
    	nodes = dom.find(".day");
    	for (i=1; i<=7; i++)
    	{
    		nodes.filter("[name=day" + i + "]")[0].classList.add(mask%2 ? "sx" : "ux");  
    		mask = mask>>1;
    	}

    	mask  = s["monthMask"];
    	nodes = dom.find(".month");
     	for (i=1; i<=12; i++)
    	{
    		nodes.filter("[name=month" + i + "]")[0].classList.add(mask%2 ? "sx" : "ux");  
    		mask = mask>>1;
    	}
    	
    	dom.find(".startTime").text(to_hhmm(s["startTime"]));
    	dom.find(".endTime").text(  to_hhmm(s["endTime"]  ));
    	dom.find(".duration").text( to_hhmm(s["duration"] ));
    	dom.find(".interval").text( to_hhmm(s["interval"] ));
    	
    	dom.find(".idCondition").text(s["idCondition"]);
    	dom.find(".idException").text(s["idException"]);
    	
    	dom.find(".conditionArgs").text(s["conditionArgs"]);
    	dom.find(".exceptionArgs").text(s["exceptionArgs"]);
    	return dom;
    }
    
    function edit_schedule(dom)
    {
    	//alert("edit_schedule: dom=" + dom);
    	id = dom.id;
    	//alert("edit_schedule: id=" + id);
    	
    	var win = window.open(
    		"/schedules/edit.html?action=edit&id=" + id + "&nonce=" + make_nonce(), 
    		"Edit schedule", 
    		"width=300,height=600,resizable=yes");
	    win.focus();
    }
    
    function add_schedule()
    {
    	var win = window.open(
    		"/schedules/edit.html?action=add&nonce=" + make_nonce(), 
    		"Add schedule", 
    		"width=300,height=600,resizable=yes");
	    win.focus();
    }
    
    function start_discovery()
    {
    	$.getJSON("/rest/discover/start?nonce=" + make_nonce(), function (data) {}).error(handle_json_error);
    }
    
    function toggle_discovery()
    {
    	$.getJSON("/rest/discover/toggle?nonce=" + make_nonce(), function (data) {}).error(handle_json_error);
    }
    
    function stop_discovery()
    {
    	$.getJSON("/rest/discover/stop?nonce=" + make_nonce(), function (data) {}).error(handle_json_error);
    }
    
    function disconnect_device()
    {
    	$.getJSON("rest/connection/stop?nonce=" + make_nonce(), function (data) {}).error(handle_json_error);
    }
        
    function select_device()
    {
    	var win = window.open(
    		"/devices/index.html?action=select&nonce=" + make_nonce(), 
    		"Select device", 
    		"width=300,height=600,resizable=yes");
	    win.focus();
    }    
    
    </script>
        
    <style type="text/css">    
body 
{
	text-align: left;
	direction: ltr;
	padding: 0;
	margin: 0;
    font-family: Arial;
    background-color: #202020;
}

.status_on
{
	background: -webkit-gradient(linear, center top, center bottom, from(#73ba8a), to(#2c8749));
	border-bottom: 1px solid #111a33;
	-webkit-box-shadow: inset 0 1px 1px -1px #fff;
	-webkit-box-sizing: border-box;
	width: 100%;
	font-family: Helvetica, sans-serif;
	font-size: 14px;
	vertical-align: middle;
}

.status_off
{
	background: -webkit-gradient(linear, center top, center bottom, from(#ff8a73), to(#a0492c));
	border-bottom: 1px solid #111a33;
	-webkit-box-shadow: inset 0 1px 1px -1px #fff;
	-webkit-box-sizing: border-box;
	width: 100%;
	font-family: Helvetica, sans-serif;
	font-size: 14px;
	vertical-align: middle;
}

.menu 
{
	background: -webkit-gradient(linear, center top, center bottom, from(#808080), to(#a0a0a0));
	border-bottom: 1px solid #111a33;
	-webkit-box-shadow: inset 0 1px 1px -1px #fff;
	-webkit-box-sizing: border-box;
	height: 43px;
	position: relative;
	width: 100%;
	font-family: Helvetica, sans-serif;
	font-size: 14px;
	-webkit-box-align: center;
	display: -webkit-box;
}

.statusPeerName
{
	height: 32px;
	/*border: 1px solid red;*/
	margin-left: auto;
    margin-right: auto;
    text-align: center;
    line-height: 32px;
}

.schedule
{
	background: -webkit-gradient(linear, center top, center bottom, from(#909090), to(#a0a0a0));
	/*background-color: #b0b0b0; */
	border-radius:    10px;
	margin:            5px;
	border: 8px outset #b0b0b0;	
}

.active
{
	background: -webkit-gradient(linear, center top, center bottom, from(#FFa0a0), to(#FF9090));
	/*background-color: #FFa0a0;*/	
	border: 8px outset #ffb0b0;	
}

.odd
{
	background: -webkit-gradient(linear, center top, center bottom, from(#b0b0b0), to(#c0c0c0));
	border: 8px outset #d0d0d0;	
}

.s 
{ 
	color: #a0ffa0;
	text-align: center;
	float: left;
	margin-left:.25em;
	margin-right:.25em;
	width: 3.2ex;
}

.monthTable
{
	display: table; 
	table-layout: fixed;	
}

.day
{
	text-align: center;
	font-size:12px;	
} 

/* selected: */
.ux
{ 
	color: #808080;  
}

/* selected: */
.sx 
{
	color: #80ff80;  
}

.spread 
{   
    width:        100%;
    margin-left:  auto; 
    margin-right: auto;
    text-align: justify;
    font-size:   0.1px; 
}

.spread div 
{
    vertical-align: top;
    display: inline-block;
    *display: inline;
    font-size:   12px;
}

.stretch 
{
    width: 100%;
    display: inline-block;
    font-size: 0;
    line-height: 0;
}

.jsonErrorLog
{
	background-color: white;
	color:            black;
	font-size:   8px;
	font-family: Arial;
}
    </style>
        
  </head>
  
  <body>
  	<div id="status" class="status_off">
  		<div class="spread">
			<div style="margin: 5px"><a href="javascript:add_schedule()"><img id="statusImage" src="./Gardenoid_files/plus.png" width="32" height="32"></a></div>
			<div id="statusPeerName" class="statusPeerName">???</div>
			<div style="margin: 5px"><a href="javascript:select_device()"><img id="cancelImage" src="./Gardenoid_files/star.png" width="32" height="32"></a></div>
		    <span class="stretch"></span>
	   </div>
	</div>
  	
  	<div id="idSchedules"><div class="schedule" style="padding:.25em;" onclick="edit_schedule(this)" id="1">

  			<div class="spread" id="monthDiv" style="margin-top:10px; margin-bottom:10px;">  		  				
				<div name="month1" class="month sx">1</div>
				<div name="month2" class="month sx">2</div>
				<div name="month3" class="month sx">3</div>
				<div name="month4" class="month sx">4</div>
				<div name="month5" class="month sx">5</div>
				<div name="month6" class="month sx">6</div> 
				<div name="month7" class="month sx">7</div> 
				<div name="month8" class="month sx">8</div>
				<div name="month9" class="month sx">9</div>
				<div name="month10" class="month sx">10</div>
				<div name="month11" class="month sx">11</div>
				<div name="month12" class="month sx">12</div>
			    <span class="stretch"></span>
			</div>
		  	
		  	<div class="spread" style="height:2em;">
			    <div style="font-size:16px">
	  					<span class="startTime">12:00</span>-<span class="endTime">18:00</span></div>
			    <div>
					<div name="strand1" class="strand sx">A</div>
					<div name="strand2" class="strand ux">B</div>
					<div name="strand3" class="strand ux">C</div>
					<div name="strand4" class="strand ux">D</div>
					<div name="strand5" class="strand ux">E</div>
					<div name="strand6" class="strand ux">F</div>
					<div name="strand7" class="strand ux">G</div>
					<div name="strand8" class="strand ux">H</div>
			    </div>
			    <div style="font-size:12px">
	  					every <span class="interval">02:00</span> for <span class="duration">00:15</span> 
			    </div>
			    <span class="stretch">X</span>
			</div>​

  			<div class="spread" name="dayDiv" style="margin-top:10px; margin-bottom:10px; clear:left;">  		  				
				<div name="day1" class="day sx">Sun</div> 
				<div name="day2" class="day sx">Mon</div>
				<div name="day3" class="day sx">Tue</div>
				<div name="day4" class="day sx">Wed</div>
				<div name="day5" class="day sx">Thu</div>
				<div name="day6" class="day sx">Fri</div>
				<div name="day7" class="day sx">Sat</div> 
			    <span class="stretch">Y</span>
		  	</div>
		  	
		  	<div name="condDiv" style="clear: left;">
		  		Condition: <span class="idCondition">0</span><span class="conditionArgs">null</span>
		  	</div>
		  	
		  	<div name="excpDiv" style="">
		  		Exception: <span class="idException">0</span><span class="exceptionArgs">null</span>
		  	</div>
		  	
	  	</div><div class="schedule odd" style="padding:.25em;" onclick="edit_schedule(this)" id="34">

  			<div class="spread" id="monthDiv" style="margin-top:10px; margin-bottom:10px;">  		  				
				<div name="month1" class="month ux">1</div>
				<div name="month2" class="month ux">2</div>
				<div name="month3" class="month ux">3</div>
				<div name="month4" class="month sx">4</div>
				<div name="month5" class="month sx">5</div>
				<div name="month6" class="month sx">6</div> 
				<div name="month7" class="month ux">7</div> 
				<div name="month8" class="month ux">8</div>
				<div name="month9" class="month ux">9</div>
				<div name="month10" class="month ux">10</div>
				<div name="month11" class="month ux">11</div>
				<div name="month12" class="month ux">12</div>
			    <span class="stretch"></span>
			</div>
		  	
		  	<div class="spread" style="height:2em;">
			    <div style="font-size:16px">
	  					<span class="startTime">08:00</span>-<span class="endTime">20:00</span></div>
			    <div>
					<div name="strand1" class="strand sx">A</div>
					<div name="strand2" class="strand ux">B</div>
					<div name="strand3" class="strand ux">C</div>
					<div name="strand4" class="strand ux">D</div>
					<div name="strand5" class="strand ux">E</div>
					<div name="strand6" class="strand ux">F</div>
					<div name="strand7" class="strand ux">G</div>
					<div name="strand8" class="strand ux">H</div>
			    </div>
			    <div style="font-size:12px">
	  					every <span class="interval">04:00</span> for <span class="duration">00:10</span> 
			    </div>
			    <span class="stretch">X</span>
			</div>​

  			<div class="spread" name="dayDiv" style="margin-top:10px; margin-bottom:10px; clear:left;">  		  				
				<div name="day1" class="day sx">Sun</div> 
				<div name="day2" class="day sx">Mon</div>
				<div name="day3" class="day sx">Tue</div>
				<div name="day4" class="day sx">Wed</div>
				<div name="day5" class="day sx">Thu</div>
				<div name="day6" class="day sx">Fri</div>
				<div name="day7" class="day sx">Sat</div> 
			    <span class="stretch">Y</span>
		  	</div>
		  	
		  	<div name="condDiv" style="clear: left;">
		  		Condition: <span class="idCondition">0</span><span class="conditionArgs"></span>
		  	</div>
		  	
		  	<div name="excpDiv" style="">
		  		Exception: <span class="idException">0</span><span class="exceptionArgs"></span>
		  	</div>
		  	
	  	</div></div>
  	
  	<div id="divSchedulesNew" class="hideTemplate" style="display:none">
  		
  		<div id="idScheduleTemplate" class="schedule" style="padding:.25em;" onclick="edit_schedule(this)">

  			<div class="spread" id="monthDiv" style="margin-top:10px; margin-bottom:10px;">  		  				
				<div name="month1" class="month">1</div>
				<div name="month2" class="month">2</div>
				<div name="month3" class="month">3</div>
				<div name="month4" class="month">4</div>
				<div name="month5" class="month">5</div>
				<div name="month6" class="month">6</div> 
				<div name="month7" class="month">7</div> 
				<div name="month8" class="month">8</div>
				<div name="month9" class="month">9</div>
				<div name="month10" class="month">10</div>
				<div name="month11" class="month">11</div>
				<div name="month12" class="month">12</div>
			    <span class="stretch"></span>
			</div>
		  	
		  	<div class="spread" style="height:2em;">
			    <div style="font-size:16px">
	  					<span class="startTime">??:??</span>-<span class="endTime">??:??
			    </span></div>
			    <div>
					<div name="strand1" class="strand">A</div>
					<div name="strand2" class="strand">B</div>
					<div name="strand3" class="strand">C</div>
					<div name="strand4" class="strand">D</div>
					<div name="strand5" class="strand">E</div>
					<div name="strand6" class="strand">F</div>
					<div name="strand7" class="strand">G</div>
					<div name="strand8" class="strand">H</div>
			    </div>
			    <div style="font-size:12px">
	  					every <span class="interval">01:00</span> for <span class="duration">00:15</span> 
			    </div>
			    <span class="stretch">X</span>
			</div>​

  			<div class="spread" name="dayDiv" style="margin-top:10px; margin-bottom:10px; clear:left;">  		  				
				<div name="day1" class="day">Sun</div> 
				<div name="day2" class="day">Mon</div>
				<div name="day3" class="day">Tue</div>
				<div name="day4" class="day">Wed</div>
				<div name="day5" class="day">Thu</div>
				<div name="day6" class="day">Fri</div>
				<div name="day7" class="day">Sat</div> 
			    <span class="stretch">Y</span>
		  	</div>
		  	
		  	<div name="condDiv" style="clear: left;">
		  		Condition: <span class="idCondition">?</span><span class="conditionArgs">??</span>
		  	</div>
		  	
		  	<div name="excpDiv" style="">
		  		Exception: <span class="idException">?</span><span class="exceptionArgs">??</span>
		  	</div>
		  	
	  	</div>
	  	
  	</div>
  	
  	<div id="menu" class="menu">  	
  		<p style="text-align: center; width:100%">  	  		
  			<a href="javascript:clear_schedules()">[CLEAR]</a>
  			<a href="javascript:update_schedules()">[UPDATE]</a>
  			<a href="javascript:show_api()">[API]</a>
  		</p>
  	</div>

  	<div id="jsonErrorLog" class="jsonErrorLog">
  	</div>
  	
  
  
  <script>
   	$(document).ready(update_status());
	$(document).ready(update_schedules());
  </script>
  

</body></html>