<!DOCTYPE html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.2//EN"
  "http://www.openmobilealliance.org/tech/DTD/xhtml-mobile12.dtd">
<html>
  <head>
    <title>Weather Conditions</title>

    <script src="js/jquery.min.js"></script>
    <script src="js/gardenoid.js"></script>
    <script src="js/conditionals.js"></script>    
    <script src="js/weather.js"></script>    
    <script>
    
var global_day = "{{day}}";
        
function next_day()
{
	var d = new Date(global_day);
	d.setTime(d.getTime()+24*60*60*1000);
	
	var y = 1900+d.getYear();
	var m = 1+d.getMonth();
	var d = d.getDate();
	
	if (m<10) m="0"+m;
	if (d<10) d="0"+d;
	
	global_day = y + "-" + m + "-" + d;
	update_content();
}    
    
function prev_day()
{
	var d = new Date(global_day);
	d.setTime(d.getTime()-24*60*60*1000);
	
	var y = 1900+d.getYear();
	var m = 1+d.getMonth();
	var d = d.getDate();
	
	if (m<10) m="0"+m;
	if (d<10) d="0"+d;
	
	global_day = y + "-" + m + "-" + d;
	update_content();
}    
    
function onclick_weather(node)
{
	var date = $(node).find("#idDate").text();
	//alert("NYI: date=" + date);	
}

function create_dom(no, template, item)
{
	var i     = item;    	 
	var id    = i["id"];
	var date  = i["date"];
	var code  = i["code"];
	var text  = i["text"];
	var temp  = i["t"];
	var humi  = i["hum"];
	var visi  = i["visi"];
	var press = i["p"];
	var rise  = i["rise"];
	var upd   = i["upd"];
	// remove date (prefix) and seconds (suffix) 
	var time  = date.replace(/.* /,"").replace(/:..$/,"");

	copy = template.clone();
	copy.removeAttr("id");
	copy.attr("id", id);
	dom = $(copy)

	/*
	var dow = new Date(day).getDay(); // 5 = friday
	if      (dow==0) dow="Sun";
	else if (dow==1) dow="Mon";
	else if (dow==2) dow="Tue";
	else if (dow==3) dow="Wed";
	else if (dow==4) dow="Thu";
	else if (dow==5) dow="Fri";
	else if (dow==6) dow="Sat";
	else if (dow==7) dow="Sun";
	
	if      ("Sun"==dow) dom.addClass("sunday");
	else if ("Sat"==dow) dom.addClass("saturday");
	else if (no%2)       dom.addClass("odd");
	*/
	
	dom.find("#idTime").text(time);
	dom.find("#idCode").text(code);
	dom.find("#idText").text(text);
	dom.find("#idTemp").text(temp);
	dom.find("#idHumi").text(humi);
	dom.find("#idVisi").text(visi);
	dom.find("#idRise").text(rise);
	var img = dom.find("#idImg")[0];
	img.src = "http://l.yimg.com/a/i/us/we/52/" + code + ".gif";
	
	return dom;
}
 
function update_content()
{
	var template = $("#idTemplate");    	
 	var target   = $("#idVisible");

 	var url = "rest/weather/list?day=" + global_day + "&nonce=" + make_nonce();
	var request = $.getJSON(url, function(data)
	{
	 	var list = data["weather"];
	 	var day  = data["day"];
	 	$("#idDay").text(day);
	 	
	 	var doms = [];
	 	$.each(list, function(i, item)
	 	{
	 		var dom = create_dom(i, template, item);	
	   	 	doms.push(dom);
	   	 	//log(item);
	 	});	    	

   	 	target.empty();
   	 	doms.forEach(function(dom)
   	 	{
   	 		target.append(dom);	
   	 	});	   	 	
	});
	
	request.error(handle_json_error);
	request.complete(function() 
	{
		updateOngoing = false;
		window.setTimeout(update_content,5*60*1000); // every 5 minutes
	});	
}
    </script>
        
    <link rel="stylesheet" href="css/gardenoid.css" type="text/css" charset="utf-8"/>         
    <link rel="stylesheet" href="css/forecast.css" type="text/css" charset="utf-8"/>
             
  </head>
  
  <body>
		
	<!-- header menu //-->
  	<div id="status" class="status_unknown">
  		<div class="spread">
			<div style="margin: 5px"> </div>
			<div id="statusPeerName" class="statusText" style="font-size: 16px;"> </div>
			<div id="statusTime"     class="statusText" style="font-size: 16px;"> </div>
			<div style="margin: 5px"><a href="forecast.html?none={{nonce}}"><img id="cancelImage" src="img/cancel.png"/></a></div>
		    <span class="stretch"> </span>
	   </div>
	</div>
  	
  	<div style="height:32px;"> </div>

	<div style="margin-top:2em; margin-bottom: 1em; width=100%">
  		<div class="spread">
			<div            class="button" onclick="prev_day()">&nbsp;&lt;&nbsp;</div>
			<div id="idDay" style="font-size:20px; color:white; text-align:center; padding-top:.5em;"> </div>
			<div            class="button" onclick="next_day()">&nbsp;&gt;&nbsp;</div>
		    <span class="stretch"> </span>
	   </div>
	</div>

  	<!-- content (empty initially, will be filled with template instances)//-->
  	<div id="idVisible" style="margin-top:.5em; margin-bottom: .5em;">
  	</div>
  	
  	<!-- this div hides the template dom //-->
  	<div id="divHidden" class="hideTemplate" style="display:none">
  		
  		<!-- template dom //-->
  		<div id="idTemplate" class="forecast" style="padding:.25em;">

  			<div id="monthDiv" style="margin-top:10px; margin-bottom:10px;" onclick="onclick_weather(this);">
  				<div style="margin-left: 1em; margin-right: 1em; float: left; text-align: center;">
  					<img id="idImg" src="http://l.yimg.com/a/i/us/we/52/34.gif"><br>
  				</div>
  				<div><span id="idTime">hh:mm</span></div>
  				<div style="display:none"><span id="idCode">code</span></div>  		  				
  				<div><span id="idTemp">temp</span> &deg;C, <span id="idText">text</span></div>  		  				
  				<div>Humidity:   <span id="idHumi">humi</span> %</div>  		  				
  				<div>Visibility: <span id="idVisi">visi</span>km</div>  		  				
  				<div>Rise:       <span id="idRise">rise</span></div>  		  				
			</div>
		  	
	  	</div>	  	
  	</div>  	
  	
  	<!-- footer menu //-->
  	<div class="menu">
  		<div class="spread">
			<div style="margin: 5px"> </div>
			<div >
				<div class="statusText" style="display: block; height:1em;">
					Power:<span id="statusPower"> </span>
				</div>
				<div class="statusText" style="display: block;  height:1em;">
					Version:<span id="statusVersion"> </span>
				</div>
			</div>
			<div style="margin: 5px"> </div>
		    <span class="stretch"> </span>
	   </div>
	</div>

  	
  	<div id="jsonErrorLog" class="jsonErrorLog">
  	</div>
  	
  	<div style="height:48px;"> </div>
  	
  </body>
  
  <script>
   	$(document).ready(update_status());
	$(document).ready(update_content());
   	window.setInterval(update_time, 1000);		    		 	
  </script>
  
</html>
